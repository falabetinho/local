define(['jquery', 'core/modal'], function($, Modal) {
    var CategoryModal = {
        init: function() {
            this.bindEvents();
        },
        
        bindEvents: function() {
            var self = this;
            
            $(document).on('click', '#add-category-btn', function(e) {
                e.preventDefault();
                var url = $(this).data('url');
                self.showCategoryModal(url, 'Add New Category');
            });
            
            $(document).on('click', '.edit-category-modal', function(e) {
                e.preventDefault();
                var url = $(this).data('url');
                var categoryName = $(this).data('category-name');
                self.showCategoryModal(url, 'Edit Category: ' + categoryName);
            });
        },
        
        showCategoryModal: function(url, title) {
            var self = this;
            
            Modal.create({
                title: title,
                body: this.getLoadingBody(),
                large: true,
                show: true
            }).then(function(modal) {
                var modalUrl = url + (url.indexOf('?') > -1 ? '&modal=1' : '?modal=1');
                $.get(modalUrl)
                    .done(function(response) {
                        modal.setBody(response);
                        self.initFormHandlers(modal);
                    })
                    .fail(function() {
                        modal.setBody('<div class="alert alert-danger">Error loading form. Please try again.</div>');
                    });
                
                return modal;
            }).catch(function(error) {
                console.error('Error creating modal:', error);
                alert('Erro ao criar modal: ' + error.message);
            });
        },
        
        initFormHandlers: function(modal) {
            var self = this;
            var modalBody = modal.getBody();
            
            modalBody.on('submit', 'form', function(e) {
                e.preventDefault();
                var form = $(this);
                var submitBtn = form.find('input[type="submit"]');
                var originalText = submitBtn.val();
                submitBtn.val('Saving...').prop('disabled', true);
                
                $.ajax({
                    url: form.attr('action') || window.location.href,
                    method: 'POST',
                    data: new FormData(form[0]),
                    processData: false,
                    contentType: false,
                    success: function(formResponse) {
                        if (formResponse.indexOf('alert-success') !== -1) {
                            modal.hide();
                            setTimeout(function() {
                                window.location.reload();
                            }, 500);
                        } else {
                            modal.setBody(formResponse);
                            self.initFormHandlers(modal);
                        }
                    },
                    error: function() {
                        modal.setBody('<div class="alert alert-danger">Error saving category. Please try again.</div>');
                    },
                    complete: function() {
                        submitBtn.val(originalText).prop('disabled', false);
                    }
                });
            });
            
            modalBody.on('click', 'input[name="cancel"]', function(e) {
                e.preventDefault();
                modal.hide();
            });
        },
        
        getLoadingBody: function() {
            return '<div class="text-center p-4">' +
                   '<i class="fa fa-spinner fa-spin fa-2x text-primary"></i><br>' +
                   '<div class="mt-2">Loading form...</div>' +
                   '</div>';
        }
    };
    
    return CategoryModal;
});