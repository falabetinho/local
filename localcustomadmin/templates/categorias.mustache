<div class="local-customadmin-categories">
    <div class="mb-4">
        <p class="lead text-muted">{{page_description}}</p>
    </div>
    
    <!-- Add Category Button -->
    <div class="mb-4">
        <button type="button" class="btn btn-primary" id="add-category-btn" data-url="{{add_category_modal_url}}">
            <i class="fas fa-plus-circle me-2"></i>{{add_category_text}}
        </button>
        <a href="{{add_category_modal_url}}" class="btn btn-outline-primary ms-2" id="add-category-fallback">
            <i class="fas fa-plus-circle me-2"></i>{{add_category_text}} (Direct)
        </a>
    </div>
    
    {{#has_categories}}
    <!-- Categories Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-sitemap me-2"></i>Categorias de Cursos
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nome da Categoria</th>
                            <th class="text-center">Cursos</th>
                            <th class="text-center">Subcategorias</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#categories}}
                        <tr>
                            <td>
                                <span class="badge bg-secondary">{{id}}</span>
                            </td>
                            <td>
                                <div>
                                    {{#is_root}}
                                    <strong>{{name}}</strong>
                                    {{/is_root}}
                                    {{^is_root}}
                                    <span class="text-muted small">{{full_path}}</span>
                                    {{/is_root}}
                                </div>
                                {{#description}}
                                <small class="text-muted d-block mt-1">{{description}}</small>
                                {{/description}}
                            </td>
                            <td class="text-center">
                                {{#courses_count}}
                                <span class="badge bg-info">{{courses_count}} cursos</span>
                                {{/courses_count}}
                                {{^courses_count}}
                                <span class="text-muted">0 cursos</span>
                                {{/courses_count}}
                            </td>
                            <td class="text-center">
                                {{#subcategories_count}}
                                <span class="badge bg-warning">{{subcategories_count}} subcategorias</span>
                                {{/subcategories_count}}
                                {{^subcategories_count}}
                                <span class="text-muted">0 subcategorias</span>
                                {{/subcategories_count}}
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    {{#subcategories_count}}
                                    <button type="button" class="btn btn-outline-info" title="Exibir Subcategorias" disabled>
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {{/subcategories_count}}
                                    <button type="button" class="btn btn-outline-primary edit-category-modal" 
                                            data-url="{{edit_modal_url}}" 
                                            data-category-name="{{name}}" 
                                            title="Editar Categoria">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{/categories}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{/has_categories}}
    
    {{^has_categories}}
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle me-2"></i>
        Nenhuma categoria de curso foi encontrada. 
        <a href="{{add_category_url}}" class="alert-link">Criar primeira categoria</a>
    </div>
    {{/has_categories}}
    
    <!-- Back to Courses Button -->
    <div class="mt-4">
        <a href="{{back_to_courses_url}}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>{{back_to_courses_text}}
        </a>
    </div>
</div>

{{#js}}
require(['jquery', 'core/modal'], function($, Modal) {
    
    console.log('JavaScript loaded successfully');
    console.log('jQuery available:', typeof $);
    console.log('Modal available:', typeof Modal);
    
function showCategoryModal(url, title) {
        console.log('Creating modal with title:', title);
        
        return Modal.create({
            title: title,
            body: '<div class="text-center p-4"><i class="fa fa-spinner fa-spin fa-2x text-primary"></i><br><div class="mt-2">Loading form...</div></div>',
            large: true,
            show: true
        }).then(function(modal) {
            console.log('Modal created successfully:', modal);
            
            // Load content via AJAX
            var modalUrl = url + (url.indexOf('?') > -1 ? '&modal=1' : '?modal=1');
            $.get(modalUrl)
                .done(function(response) {
                    modal.setBody(response);
                    
                    // Handle form submission directly
                    var modalBody = modal.getBody();
                    modalBody.on('submit', 'form', function(e) {
                        e.preventDefault();
                        var form = $(this);
                        
                        var submitBtn = form.find('input[type="submit"]');
                        var originalText = submitBtn.val();
                        submitBtn.val('Saving...').prop('disabled', true);
                        
                        $.ajax({
                            url: form.attr('action') || window.location.href,
                            method: 'POST',
                            data: new FormData(form[0]),
                            processData: false,
                            contentType: false,
                            success: function(formResponse) {
                                if (formResponse.indexOf('alert-success') !== -1) {
                                    modal.hide();
                                    setTimeout(function() {
                                        window.location.reload();
                                    }, 500);
                                } else {
                                    modal.setBody(formResponse);
                                }
                            },
                            error: function() {
                                modal.setBody('<div class="alert alert-danger">Error saving category. Please try again.</div>');
                            },
                            complete: function() {
                                submitBtn.val(originalText).prop('disabled', false);
                            }
                        });
                    });
                    
                    // Handle cancel button
                    modalBody.on('click', 'input[name="cancel"]', function(e) {
                        e.preventDefault();
                        modal.hide();
                    });
                    
                })
                .fail(function() {
                    modal.setBody('<div class="alert alert-danger">Error loading form. Please try again.</div>');
                });
            
            return modal;
        }).catch(function(error) {
            console.error('Error creating modal:', error);
            alert('Erro ao criar modal: ' + error.message);
        });
    }
    
    // Wait for DOM to be ready
    $(document).ready(function() {
        console.log('DOM ready');
        console.log('Add button exists:', $('#add-category-btn').length);
        console.log('Edit buttons exist:', $('.edit-category-modal').length);
    });
    
    $(document).on('click', '#add-category-btn', function(e) {
        e.preventDefault();
        console.log('Add category button clicked');
        var url = $(this).data('url');
        console.log('URL:', url);
        if (url) {
            showCategoryModal(url, 'Add New Category');
        } else {
            console.error('No URL found for modal');
            alert('Erro: URL não encontrada para o modal');
        }
    });
    
    $(document).on('click', '.edit-category-modal', function(e) {
        e.preventDefault();
        console.log('Edit category button clicked');
        var url = $(this).data('url');
        var categoryName = $(this).data('category-name');
        console.log('URL:', url, 'Category:', categoryName);
        if (url) {
            showCategoryModal(url, 'Edit Category: ' + categoryName);
        } else {
            console.error('No URL found for edit modal');
            alert('Erro: URL não encontrada para o modal de edição');
        }
    });

});
{{/js}}